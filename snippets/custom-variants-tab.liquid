<!-- custom-variants-tab -->
{% comment %}
  Custom Variant Picker with Tab-based UI
  Variant 1: Metal
  Variant 2: Diamond
  UI Tabs: Gold, Platinum, Lab Grown
{% endcomment %}

<style>
  .tab-heading-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 16px 0;
    position: relative;
  }
  .tab-heading {
    font-weight: 700;
    font-size: clamp(17.6px, calc(22 * (100vw / 1440)), 26.4px);
    line-height: 100%;
    letter-spacing: 0.22px;
    color: #86868b;
    margin: unset;
  }
  .info-txt {
    font-weight: 400;
    font-size: clamp(11.2px, calc(14 * (100vw / 1440)), 16.8px);
    line-height: 100%;
    letter-spacing: 0px;
    color: #6c6c6c;
    margin: unset;
    display: flex;
    gap: 5px;
    cursor: pointer;
  }
  .info-txt span {
    border-radius: 50%;
    border: 1px solid #6c6c6c;
    width: 14px;
    height: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .tab {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  .tab button {
    padding: 17px;
    background: none;
    border: 1px solid #1c1b1f4d;
    cursor: pointer;
    border-radius: 4px;
  }
  .tab button.tablinks {
    width: 100%;
    height: auto;
    border-radius: 12px;
    text-transform: capitalize;
    display: flex;
    flex-direction: column;
  }
  .tab button.tablinks:before {
    content: '';
    display: block;
    width: 16.5%;
    aspect-ratio: 1 / 1;
    border-radius: 50%;
    margin: 0 auto;
    margin-bottom: 8px;
  }
  .tab button.tablinks span {
    font-weight: 400;
    font-size: 12px;
    line-height: 18px;
    letter-spacing: 0px;
    color: #6e6e73;
  }
  .tab button.gold-tab:before {
    background: linear-gradient(180deg, #fcf0dd 0%, #ffa20c 100%);
  }
  .tab button.platinum-tab:before {
    background: linear-gradient(179.1deg, rgba(99, 97, 97, 0) -13.32%, #636161 99.23%);
  }
  .tab button.labgrown-tab:before {
    background: linear-gradient(180deg, rgba(226, 226, 226, 0) 0%, #e2e2e2 100%);
  }
  .tabcontent {
    display: none;
  }
  .variant-card-container {
    gap: 10.5px;
    padding-bottom: 10px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
  }
  .gold-variants-container {
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }
  .gold-column {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .gold-column .variant-card-container {
    display: flex;
    flex-direction: column;
    gap: 10.5px;
    padding-bottom: 0;
  }
  .variant-link {
    text-decoration: none;
    flex: 0 0 32%;
    cursor: pointer;
  }
  .variant-box {
    border: 1px solid #1c1b1f4d;
    border-radius: 8px;
    padding: 16px;
    background: #fff;
    width: 100%;
    box-shadow: 0 0 3px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .top-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  .variant-image {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 6px;
  }
  .metal-name-top-right {
    font-size: 8px;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 4px;
    background: linear-gradient(90deg, #d4af37 0%, #f9d423 100%);
    color: #000;
  }
  .metal-name-top-right.lab-grown {
    background: linear-gradient(90deg, #b5f3ff 0%, #79e2fb 100%);
  }
  .variant-name {
    font-weight: 500;
    font-size: clamp(12.8px, calc(16 * (100vw / 1440)), 19.2px);
    line-height: clamp(19.2px, calc(24 * (100vw / 1440)), 28.8px);
    letter-spacing: 0px;
    margin: unset;
  }
  .variant-pack-size {
    font-weight: 400;
    font-size: clamp(9.6px, calc(12 * (100vw / 1440)), 14.4px);
    line-height: clamp(14.4px, calc(18 * (100vw / 1440)), 21.6px);
    letter-spacing: 0px;
    margin: unset;
  }
  .price-container {
    display: flex;
    align-items: center;
    gap: 2px;
  }
  .variant-price {
    font-weight: 600;
    font-size: 14px;
    line-height: 21px;
    letter-spacing: 0px;
    margin: unset;
  }
  .plus-breakup-text {
    font-weight: 600;
    font-size: clamp(11.2px, calc(14 * (100vw / 1440)), 16.8px);
    line-height: clamp(16.8px, calc(21 * (100vw / 1440)), 25.2px);
    letter-spacing: 0px;
  }
  .variant-color-clarity {
    font-size: 11px;
    color: #666;
  }
  .price {
    font-size: 11px !important;
    font-weight: bold;
    color: #000;
  }
  .variant-box.selected {
    outline: 1px solid #000000;
  }
  .variant-help-box {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    border: 1px solid #d2c7ff;
    border-radius: 8px;
    padding: 16px;
    background: #fff;
    box-shadow: 0 0 0 1px rgba(130, 70, 255, 0.1);
  }
  .variant-help-box.step-2 {
    display: none;
  }
  .variant-help-icon {
    background: linear-gradient(90deg, #4c79ff 0%, #a84bff 100%);
    color: #fff;
    font-weight: 700;
    font-size: 18px;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .variant-help-content h3 {
    font-weight: 500;
    font-size: clamp(12.8px, calc(16 * (100vw / 1440)), 19.2px);
    line-height: clamp(19.2px, calc(24 * (100vw / 1440)), 28.8px);
    letter-spacing: 0px;
    margin: unset;
  }
  .variant-help-content p {
    font-weight: 400;
    font-size: clamp(9.6px, calc(12 * (100vw / 1440)), 14.4px);
    line-height: clamp(14.4px, calc(18 * (100vw / 1440)), 21.6px);
    letter-spacing: 0px;
    margin: 4px 0 10px 0;
  }
  .try-btn {
    font-family: var(--oregon-font);
    background: linear-gradient(90deg, #4c79ff 0%, #a84bff 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: opacity 0.2s;
    font-weight: 600;
    font-size: clamp(11.2px, calc(14 * (100vw / 1440)), 16.8px);
    line-height: clamp(16.8px, calc(21 * (100vw / 1440)), 25.2px);
    letter-spacing: 0px;
  }
  .try-btn:hover {
    opacity: 0.9;
  }
  .price-options-container-modal {
    max-width: 400px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    font-family: var(--oregon-font);
    font-size: 14px;
    line-height: 1.5;
    position: absolute;
    top: 60px;
  }
  .price-options-main {
    padding: 16px;
    padding-bottom: 0;
  }
  .price-options-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .price-options-header h3 {
    margin: unset;
    font-weight: 600;
    font-size: 22px;
    line-height: 100%;
    letter-spacing: 0px;
  }
  .close-btn {
    border: none;
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    color: #555;
  }
  .price-options-desc {
    margin: 6px 0 16px 0;
    color: #86868b;
    font-family: var(--oregon-font);
    font-weight: 500;
    font-size: 16px;
    line-height: 24px;
    letter-spacing: 0px;
  }
  .price-options-section {
    margin: 10px 0;
  }
  .price-options-section strong {
    display: block;
    color: #1d1d1f;
    font-weight: 500;
    font-size: 16px;
    line-height: 24px;
    letter-spacing: 0px;
  }
  .price-options-section ul {
    margin: 0;
    padding-left: 16px;
    list-style-type: disc;
    color: #444;
  }
  .price-options-section li {
    font-weight: 500;
    font-size: 14px;
    line-height: 21px;
    letter-spacing: 0px;
    color: #86868b;
  }
  .price-options-note {
    margin: unset;
    padding: 16px;
    margin-top: 16px;
    color: #86868b;
    font-size: 16px;
    line-height: 24px;
    letter-spacing: 0px;
    border-top: 1px solid #0000001a;
  }
  .ai-question {
    margin-bottom: 20px;
  }
  .ai-option {
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 20px;
    padding: 5px 10px;
    margin-top: 5px;
    cursor: pointer;
    user-select: none;
    font-size: 12px;
  }
  .ai-option.selected {
    border-color: black;
    background-color: #f1f1f1;
    font-weight: bold;
  }
  .get-recommendation-btn {
    background: linear-gradient(90deg, #4c79ff 0%, #a84bff 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: opacity 0.2s;
    font-weight: 600;
    font-size: clamp(11.2px, calc(14 * (100vw / 1440)), 16.8px);
    line-height: clamp(16.8px, calc(21 * (100vw / 1440)), 25.2px);
    letter-spacing: 0px;
  }
  .get-recommendation-btn:hover {
    opacity: 0.9;
  }
  .answerWrapper {
    display: none;
  }
  .ai-loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #8b5cf6; /* Purple accent */
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  .ai-loader-message {
    color: #555;
    font-size: 16px;
    text-align: center;
    max-width: 260px;
    line-height: 1.4;
  }
  .ai-loader-sparkle {
    color: #8b5cf6;
    font-size: 18px;
  }

  .ai-error {
    font-size: 1.1rem;
    background: -webkit-linear-gradient(#eee, #333);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
</style>

<div class="tab-heading-container">
  <h2 class="tab-heading">Pick Your Personal Price</h2>
  <p class="info-txt"><span>?</span>How do you offer 12 price options?</p>

  {% comment %} modal {% endcomment %}
  <div class="price-options-container-modal hidden">
    <div class="price-options-main">
      <div class="price-options-header">
        <h3>12 Price Options Explained</h3>
        <button class="close-btn">{% render 'close-icon-svg' %}</button>
      </div>
      <p class="price-options-desc">We offer 12 different price combinations by varying three key factors:</p>
      <div class="price-options-section">
        <strong>Metal Type:</strong>
        <ul>
          <li>14KT Gold, 18KT Gold, Platinum 950</li>
        </ul>
      </div>
      <div class="price-options-section">
        <strong>Diamond Grade:</strong>
        <ul>
          <li>IJ-SI, GH-VS, EF-VVS</li>
        </ul>
      </div>
      <div class="price-options-section">
        <strong>Diamond Origin:</strong>
        <ul>
          <li>Natural or Lab Grown</li>
        </ul>
      </div>
    </div>
    <p class="price-options-note">
      Each combination offers a unique balance of quality, beauty, and value to match your preferences and budget.
    </p>
  </div>
</div>

<!-- Tabs UI -->
<div class="tab">
  <button class="tablinks gold-tab" data-metal="gold" onclick="openVariantTab(event, 'goldTab')">
    Gold<span>(Natural Diamond)</span>
  </button>
  <button class="tablinks platinum-tab" data-metal="platinum" onclick="openVariantTab(event, 'platinumTab')">
    Platinum<span>(Natural Diamond)</span>
  </button>
  <button class="tablinks labgrown-tab" data-metal="lab" onclick="openVariantTab(event, 'labgrownTab')">
    Lab Grown<span>(Gold & Platinum)</span>
  </button>
</div>

<!-- Hidden input for variant -->
<input
  type="hidden"
  name="id"
  id="SelectedVariantId"
  value="{{ product.selected_or_first_available_variant.id }}"
  form="product-form-{{ section.id }}"
>

<!-- Variant Tabs Content -->
<div id="goldTab" data-metal="gold" class="tabcontent">
  <div class="gold-variants-container">
    <!-- Left column: 14KT -->
    <div class="gold-column gold-14k">
      <div class="variant-card-container">
        {% for variant in product.variants %}
          {% assign metal = variant.option1 | downcase %}
          {% assign diamond = variant.option2 | downcase %}
          {% if metal contains 'gold' and diamond contains 'natural' %}
            {% if variant.title contains '14KT' or variant.title contains '14K' %}
              <div
                class="variant-link"
                data-variant-id="{{ variant.id }}"
                data-option1="{{ variant.option1 }}"
                data-option2="{{ variant.option2 }}"
                onclick="selectVariant('{{ variant.id }}', this)"
              >
                <div class="variant-box" data-variant-id="{{ variant.id }}">
                  <div class="top-row">
                    <h2 class="variant-name"></h2>
                  </div>
                  <p class="variant-pack-size">
                    {{ variant.title | replace: '/', '' | strip }}
                  </p>
                  <div class="price-container" data-variant-id="{{ variant.id }}">
                    <p class="variant-price"></p>
                    <span class="plus-breakup-text">+ Break-up</span>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Right column: 18KT -->
    <div class="gold-column gold-18k">
      <div class="variant-card-container">
        {% for variant in product.variants %}
          {% assign metal = variant.option1 | downcase %}
          {% assign diamond = variant.option2 | downcase %}
          {% if metal contains 'gold' and diamond contains 'natural' %}
            {% if variant.title contains '18KT' or variant.title contains '18K' %}
              <div
                class="variant-link"
                data-variant-id="{{ variant.id }}"
                data-option1="{{ variant.option1 }}"
                data-option2="{{ variant.option2 }}"
                onclick="selectVariant('{{ variant.id }}', this)"
              >
                <div class="variant-box" data-variant-id="{{ variant.id }}">
                  <div class="top-row">
                    <h2 class="variant-name"></h2>
                  </div>
                  <p class="variant-pack-size">
                    {{ variant.title | replace: '/', '' | strip }}
                  </p>
                  <div class="price-container" data-variant-id="{{ variant.id }}">
                    <p class="variant-price"></p>
                    <span class="plus-breakup-text">+ Break-up</span>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div id="platinumTab" data-metal="platinum" class="tabcontent">
  <div class="variant-card-container">
    {% for variant in product.variants %}
      {% assign metal = variant.option1 | downcase %}
      {% assign diamond = variant.option2 | downcase %}
      {% unless diamond contains 'lab grown' or diamond contains 'lab' %}
        {% if metal contains 'platinum' %}
          <div
            class="variant-link"
            data-variant-id="{{ variant.id }}"
            data-option1="{{ variant.option1 }}"
            data-option2="{{ variant.option2 }}"
            onclick="selectVariant('{{ variant.id }}', this)"
          >
            <div class="variant-box" data-variant-id="{{ variant.id }}">
              <div class="top-row">
                <h2 class="variant-name"></h2>
              </div>
              <p class="variant-pack-size">
                {{ variant.title | replace: 'Gold', '' | replace: 'Lab Grown', '' | replace: '/', '' | strip }}
              </p>
              <div class="price-container" data-variant-id="{{ variant.id }}">
                <p class="variant-price"></p>
                <span class="plus-breakup-text">+ Break-up</span>
              </div>
              {% comment %} <p class="variant-color-clarity">{{ variant.option2 }}</p> {% endcomment %}
            </div>
          </div>
        {% endif %}
      {% endunless %}
    {% endfor %}
  </div>
</div>

<div id="labgrownTab" data-metal="lab" class="tabcontent">
  <div class="variant-card-container">
    {% for variant in product.variants %}
      {% assign diamond = variant.option2 | downcase %}
      {% if diamond contains 'lab grown' or diamond contains 'lab' %}
        <div
          class="variant-link"
          data-variant-id="{{ variant.id }}"
          data-option1="{{ variant.option1 }}"
          data-option2="{{ variant.option2 }}"
          onclick="selectVariant('{{ variant.id }}', this)"
        >
          <div class="variant-box" data-variant-id="{{ variant.id }}">
            <div class="top-row">
              <h2 class="variant-name"></h2>
            </div>
            <p class="variant-pack-size">
              {{ variant.title | replace: 'Platinum', '' | replace: 'Natural', '' | replace: '/', '' | strip }}
            </p>
            <div class="price-container" data-variant-id="{{ variant.id }}">
              <p class="variant-price"></p>
              <span class="plus-breakup-text">+ Break-up</span>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

<div class="variant-help-box step-1">
  <div class="variant-help-icon">?</div>
  <div class="variant-help-content">
    <h3>Need help choosing a Variant?</h3>
    <p>
      You should pick something which is suitable to your daily routine and purpose of purchase. Our AI will understand
      you and provide a personal recommendation.
    </p>
    <button class="try-btn" onclick="openRecommendationStep2()">
      Try it Out
      <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="10" viewBox="0 0 14 10" fill="none">
          <path d="M8.46999 1.52991C8.3963 1.46125 8.3372 1.37845 8.29621 1.28645C8.25522 1.19445 8.23317 1.09513 8.2314 0.994432C8.22962 0.893729 8.24814 0.7937 8.28587 0.700312C8.32359 0.606923 8.37973 0.52209 8.45095 0.450871C8.52217 0.379652 8.607 0.323508 8.70039 0.285787C8.79378 0.248066 8.89381 0.229541 8.99451 0.231318C9.09521 0.233095 9.19453 0.255136 9.28653 0.296128C9.37853 0.33712 9.46133 0.396222 9.52999 0.469909L13.53 4.46991C13.6704 4.61054 13.7493 4.80116 13.7493 4.99991C13.7493 5.19866 13.6704 5.38928 13.53 5.52991L9.52999 9.52991C9.46133 9.6036 9.37853 9.6627 9.28653 9.70369C9.19453 9.74468 9.09521 9.76672 8.99451 9.7685C8.89381 9.77028 8.79378 9.75175 8.70039 9.71403C8.607 9.67631 8.52217 9.62017 8.45095 9.54895C8.37973 9.47773 8.32359 9.39289 8.28587 9.29951C8.24814 9.20612 8.22962 9.10609 8.2314 9.00539C8.23317 8.90468 8.25522 8.80537 8.29621 8.71337C8.3372 8.62137 8.3963 8.53857 8.46999 8.46991L11.19 5.74991H1.49999C1.30108 5.74991 1.11031 5.67089 0.969658 5.53024C0.829005 5.38959 0.749989 5.19882 0.749989 4.99991C0.749989 4.801 0.829005 4.61023 0.969658 4.46958C1.11031 4.32893 1.30108 4.24991 1.49999 4.24991H11.19L8.46999 1.52991Z" fill="white"/>
        </svg>
      </span>
    </button>
  </div>
</div>

<div class="variant-help-box step-2">
  <div class="variant-help-icon">?</div>
  <div class="variant-help-content">
    <h3>Help us understand your preferences</h3>
    <p>Select words that best describe yours needs and lifestyle.</p>
    <div class="questionWrapper">
      <h3>Top priorities for your ring (Select up to two options)</h3>
      <div class="ai-question" id="priority">
        <span class="ai-option">Right Design & Budget, Resale</span>
        <span class="ai-option">Right Design & Best Budget</span>
        <span class="ai-option">Investment & Resale</span>
        <span class="ai-option">Exclusivity and Emotion over logic</span>
        <p class="hidden ai-error">Please select an option!</p>
      </div>

      <h3>Wear frequency</h3>
      <div class="ai-question" id="wear_frequency">
        <span class="ai-option">Everyday</span>
        <span class="ai-option">Ocassionally</span>
        <p class="hidden ai-error">Please select an option!</p>
      </div>

      <h3>Lifestyle</h3>
      <div class="ai-question" id="lifestyle">
        <span class="ai-option">Physically Active</span>
        <span class="ai-option">White-Collared</span>
        <p class="hidden ai-error">Please select an option!</p>
      </div>

      <h3>Metal Tone</h3>
      <div class="ai-question" id="tone">
        <span class="ai-option">Yellow</span>
        <span class="ai-option">Rose</span>
        <span class="ai-option">White</span>
        <p class="hidden ai-error">Please select an option!</p>
      </div>

      <h3>Metal Allergic</h3>
      <div class="ai-question" id="allergic">
        <span class="ai-option">Yes</span>
        <span class="ai-option">No</span>
        <p class="hidden ai-error">Please select an option!</p>
      </div>
    </div>

    <div class="answerWrapper">
      <div>
        <span class="icon">âœ¨</span>
        <span>AI Recommendation</span>
      </div>
      <p class="product-name">-</p>
      <p class="product-detail">-</p>
      <p class="product-price">-</p>
      <p class="note">Based on your preferences: -</p>
    </div>
    <div class="ai-loader hidden">
      <div class="ai-loader-message">
        <span class="ai-loader-sparkle">âœ¨</span>
      </div>
    </div>
    <p class="hidden ai-api-error">Oops! Our AI went diamond hunting and got lost. Try again in a bit!</p>
    <button class="get-recommendation-btn" onclick="getRecommendation()">Get Recommendations</button>
    <button class="choose-variant-btn get-recommendation-btn hidden" onclick="chooseRecommendedVariant(this)">
      Choose Variant
    </button>
    <button class="try-again-btn get-recommendation-btn hidden" onclick="tryAgain()">Try Again</button>
  </div>
</div>

<script>
  window.productVariants = {{ product.variants | json }};
</script>

<script>
  (function () {
    'use strict';
    // Tab and Variant Management
    const VariantTabManager = {
      currentTab: null,
      init() {
        // Wait for ProductState to be ready
        if (!window.ProductState?.isInitialized) {
          setTimeout(() => this.init(), 100);
          return;
        }
        this.initializeFromURL();
      },
      initializeFromURL() {
        const urlVariant = window.ProductState.selectedVariantId;
        if (urlVariant) {
          const variantElement = document.querySelector(`.variant-box[data-variant-id="${urlVariant}"]`);
          if (variantElement) {
            const tabContent = variantElement.closest('.tabcontent');
            if (tabContent) {
              this.activateTabByContent(tabContent);
              this.selectVariantById(urlVariant);
              return;
            }
          }
        }

        // Default to Gold tab if no specific variant found
        this.openTab('goldTab');
      },
      openTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tabcontent').forEach((el) => (el.style.display = 'none'));
        document.querySelectorAll('.tablinks').forEach((btn) => btn.classList.remove('active'));
        // Show selected tab
        const tabContent = document.getElementById(tabName);
        const tabButton = document.querySelector(`[onclick*="${tabName}"]`);
        if (tabContent) {
          tabContent.style.display = 'block';
          this.currentTab = tabName;
        }
        if (tabButton) {
          tabButton.classList.add('active');
        }
        // Auto-select variant in this tab
        this.autoSelectVariantInTab(tabContent);
      },
      activateTabByContent(tabContent) {
        if (!tabContent) return;
        // Hide all tabs first
        document.querySelectorAll('.tabcontent').forEach((el) => (el.style.display = 'none'));
        document.querySelectorAll('.tablinks').forEach((btn) => btn.classList.remove('active'));
        // Show this tab
        tabContent.style.display = 'block';
        this.currentTab = tabContent.id;
        // Activate corresponding button
        const metalType = tabContent.getAttribute('data-metal');
        const tabButton = document.querySelector(`.tablinks[data-metal="${metalType}"]`);
        if (tabButton) {
          tabButton.classList.add('active');
        }
      },
      autoSelectVariantInTab(tabContent) {
        if (!tabContent) return;
        const currentVariantId = window.ProductState.selectedVariantId;
        // Check if current variant exists in this tab
        let variantToSelect = tabContent.querySelector(`.variant-link[data-variant-id="${currentVariantId}"]`);
        // If not found, select first available variant in tab
        if (!variantToSelect) {
          variantToSelect = tabContent.querySelector('.variant-link');
        }
        if (variantToSelect) {
          const variantId = variantToSelect.getAttribute('data-variant-id');
          this.selectVariantById(variantId, false); // Don't trigger price update yet
        }
      },
      selectVariantById(variantId, triggerPriceUpdate = true) {
        // Update visual selection
        const earlierSelected = document.querySelector('.variant-box.selected');
        document.querySelectorAll('.variant-box').forEach((box) => {
          box.classList.remove('selected');
        });
        const selectedBox = document.querySelector(`.variant-box[data-variant-id="${variantId}"]`);

        if (selectedBox) {
          selectedBox.classList.add('selected');
        }
        // Update form inputs
        const variantInput = document.getElementById('SelectedVariantId');
        if (variantInput) {
          variantInput.value = variantId;
        }
        // Update main product form
        const mainForm = document.querySelector('form[action*="/cart/add"]');
        if (mainForm) {
          const mainVariantInput = mainForm.querySelector('input[name="id"]');
          if (mainVariantInput) {
            mainVariantInput.value = variantId;
          }
        }
        // Update ProductState
        if (window.ProductState) {
          if (triggerPriceUpdate) {
            window.ProductState.updateVariant(variantId);
          } else {
            window.ProductState.selectedVariantId = variantId;
            window.ProductState.updateURL();
          }
        }
        // Check for Platinum specific personalisation
        if (earlierSelected) {
          const isEarlierPlatinum = earlierSelected.parentElement
            .getAttribute('data-option1')
            ?.toLowerCase()
            .includes('platinum');
          const isNewPlatinum = selectedBox.parentElement
            .getAttribute('data-option1')
            ?.toLowerCase()
            .includes('platinum');
          if (isEarlierPlatinum !== isNewPlatinum) {
            //only open modal if personalisation was added previously
            const personalisationAdded = document.querySelector('.personalization-summary.hidden');
            if (!personalisationAdded) {
              console.log('Personalisation was added previously');
              const modalMainBody = document.querySelector('#var-change-confirmation-modal .modal-main-body');
              if (isNewPlatinum) {
                modalMainBody.innerText =
                  'You have changed the variant from Gold to Platinum. Please reselect your Metal Tone and Metal Finish to continue';
              } else {
                modalMainBody.innerText =
                  'You have changed the variant from Platinum to Gold. Please reselect your Metal Tone and Metal Finish to continue';
              }
              document.getElementById('var-change-confirmation-modal').classList.add('active');
            }
          }
        }

        // Notify other components that variant changed
        try {
          document.dispatchEvent(new CustomEvent('pdp:variant-changed', { detail: { variantId } }));
        } catch (e) {}
        // Update pickup availability
        const pickupEl = document.querySelector('pickup-availability');
        if (pickupEl && typeof pickupEl.fetchAvailability === 'function') {
          pickupEl.fetchAvailability(variantId);
        }
      },
    };
    // Public functions for onclick handlers
    window.openVariantTab = function (evt, tabName) {
      VariantTabManager.openTab(tabName);
    };
    window.selectVariant = function (variantId, element) {
      VariantTabManager.selectVariantById(variantId);
    };
    // Initialize when DOM is ready
    function initialize() {
      console.log('ðŸŽ¬ VariantTabManager initializing...');
      VariantTabManager.init();
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        console.log('ðŸ“„ DOM Content Loaded - initializing VariantTabManager');
        initialize();
      });
    } else {
      console.log('ðŸ“„ DOM already ready - initializing VariantTabManager immediately');
      initialize();
    }
    // Handle browser back/forward navigation
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        // Browser back/forward navigation - preserve URL parameters
        setTimeout(() => {
          // Re-read URL parameters to get the correct state
          const url = new URL(window.location);
          const urlVariant = url.searchParams.get('variant');
          const urlSize = url.searchParams.get('size');
          if (urlVariant) {
            window.ProductState.selectedVariantId = urlVariant;
          }
          if (urlSize) {
            window.ProductState.selectedSize = urlSize;
            const sizeSelect = document.getElementById('custom-size-selector');
            if (sizeSelect) {
              sizeSelect.value = urlSize;
            }
          }
          VariantTabManager.initializeFromURL();
          // Trigger price update with the correct variant and size
          if (urlVariant && urlSize) {
            window.ProductState.updatePrice();
          }
        }, 100);
      }
    });
  })();
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const trigger = document.querySelector('.info-txt');
    const container = document.querySelector('.price-options-container-modal');
    const closeBtn = container.querySelector('.close-btn');
    const priceBreakupModal = document.querySelector('.price-breakdown-container');
    const pbCloseBtn = priceBreakupModal.querySelector('.pb-close-btn');
    const pbOverlay = document.querySelector('.pb-overlay');
    const diamondModal = priceBreakupModal.querySelector('.diamond-modal');
    const diamondCloseBtnEl = priceBreakupModal.querySelector('.diamond-modal .diamond-modal-close');
    const dmOverlay = priceBreakupModal.querySelector('.dm-overlay');
    const solitaireModal = priceBreakupModal.querySelector('.solitaire-modal');
    const solOverlay = priceBreakupModal.querySelector('.sol-overlay');
    const solitaireCloseBtn = priceBreakupModal.querySelector('.solitaire-modal .solitaire-modal-close');
    // Open modal
    trigger?.addEventListener('click', () => container?.classList.remove('hidden'));
    // Close modal
    closeBtn?.addEventListener('click', () => container?.classList.add('hidden'));
    pbCloseBtn?.addEventListener('click', () => {
      priceBreakupModal?.classList.add('hidden');
      pbOverlay?.classList.add('hidden');
    });
        // Close handlers for diamond and solitaire modals
    if (diamondCloseBtnEl) {
      diamondCloseBtnEl.addEventListener('click', () => {
        diamondModal?.classList.add('hidden');
        dmOverlay?.classList.add('hidden');
      });
    }
    if (solitaireCloseBtn) {
      solitaireCloseBtn.addEventListener('click', () => {
        solitaireModal?.classList.add('hidden');
        solOverlay?.classList.add('hidden');
      });
    }
    // clicking the overlay should close respective modal
    solOverlay?.addEventListener('click', () => {
      solitaireModal?.classList.add('hidden');
      solOverlay?.classList.add('hidden');
    });
    dmOverlay?.addEventListener('click', () => {
      diamondModal?.classList.add('hidden');
      dmOverlay?.classList.add('hidden');
    });
    priceBreakupModal?.addEventListener('click', (event) => {
      const clickedHead = event.target.closest('.diamond-head, .solitaire-head');
      if (!clickedHead) return;

      // If the clicked element is the solitaire entry, show solitaire modal with its values.
      const isSolitaire = !!event.target.closest('.solitaire-head') || clickedHead.classList.contains('solitaire-head');
      const solitaireSection = priceBreakupModal.querySelector('.solitaire-section');

      if (isSolitaire && solitaireSection && !solitaireSection.classList.contains('hidden') && solitaireModal) {
        // Read full details array and render one card per solitaire detail
        const sDetailsJson = solitaireSection.dataset.sDetails || '[]';
        let sDetails = [];
        try {
          sDetails = JSON.parse(sDetailsJson);
        } catch (e) {
          sDetails = [];
        }

        // Remove previously generated cards (from earlier opens)
        Array.from(solitaireModal.querySelectorAll('[data-generated]')).forEach((el) => el.remove());

        const templateCard = solitaireModal.querySelector('.solitaire-modal-card');
        let totalValue = 0;
        sDetails.forEach((d, idx) => {
          const clone = templateCard.cloneNode(true);
          clone.removeAttribute('hidden');
          clone.dataset.generated = 'true';
          clone.classList.remove('hidden');
          const price = Number(d.price || 0);
          totalValue += price;
          const shape = d.shape || '';
          const carat = d.carat || 0;
          clone.querySelector('.solitaire-modal-price').textContent = `â‚¹${formatPrice(price)}`;
          clone.querySelector('.solitaire-modal-sub').textContent = `${formatCarat(carat)} ct${shape ? ' | ' + shape : ''}`;
          clone.querySelector('.solitaire-modal-carat').textContent = `Carat: ${formatCarat(carat)} ct`;
          clone.querySelector('.solitaire-modal-grade').textContent = `Grade: ${d.color || 'â€”'}-${d.clarity || 'â€”'}`;
          clone.querySelector('.solitaire-modal-name').textContent = d.shape ? d.shape : 'Solitaire';
          const totalsEl = solitaireModal.querySelector('.solitaire-modal-total');
          totalsEl.parentNode.insertBefore(clone, totalsEl);
        });

        // Metal header: include solitaire origin if available, otherwise reuse diamond header or breakdown subtitle
        const baseMetalText = diamondModal?.querySelector('.diamond-modal-metal')?.textContent || priceBreakupModal.querySelector('.pb-title-subtitle')?.textContent || '';
        solitaireModal.querySelector('.solitaire-modal-metal').textContent = baseMetalText;

        solitaireModal.querySelector('.solitaire-pieces').textContent = `${sDetails.length} pieces`;
        solitaireModal.querySelector('.solitaire-value').textContent = `â‚¹${formatPrice(totalValue)}`;

        solitaireModal.classList.remove('hidden');
        solOverlay.classList.remove('hidden');
        event.stopPropagation();
        return;
      }

      // Fallback: open the diamond modal for other diamond-head clicks
      diamondModal?.classList.remove('hidden');
      dmOverlay?.classList.remove('hidden');
      event.stopPropagation();
    });
    // Handle click on all .variant-price elements
    document.querySelectorAll('.price-container').forEach((priceEl) => {
      priceEl.addEventListener('click', (e) => {
        e.stopPropagation();
        const variantId = priceEl.dataset.variantId;
        console.log('âœ… Clicked variant:', variantId);
        const selectedVariant = currentVariants.find((v) => v.variantId?.split('/').pop() === variantId);
        console.log('ðŸš€ ~ selectedVariant:', selectedVariant);
        if (!selectedVariant) {
          console.warn('Variant not found for ID:', variantId);
          return;
        }
        const configDiamondData = Object.values(selectedVariant.price)[0];
        const selectedVariantName = selectedVariant.variantName;
        const selectedVariantMetalPurity = configDiamondData.metal.purity;
        const selectedVariantDiamondData = configDiamondData.diamond;
        const selectedVariantDiamondColor = selectedVariantDiamondData.color;
        const selectedVariantDiamondClarity = selectedVariantDiamondData.clarity;
        const diamondSectionEl = document.querySelector('.pb-section.diamond-section');
        let priceBreakDownTopSubTitleText = selectedVariantMetalPurity;
        // get diamond pricing from shapes
        // fallback to empty arrays
        const diamondRound = selectedVariantDiamondData.round || [];
        const diamondOthers = selectedVariantDiamondData.others || [];
        // Sum up prices and carats from both arrays
        const diamondTotalPrice = [...diamondRound, ...diamondOthers].reduce(
          (sum, item) => sum + (parseFloat(item.price) || 0),
          0
        );
        const diamondTotalCarat = [...diamondRound, ...diamondOthers].reduce(
          (sum, item) => sum + (parseFloat(item.carat) || 0),
          0
        );
        // Set price breakdown modal subtitle text if diamond color & clarity is present
        // If solitaire data exists for this price, detect both presence and ensure both sections show
        const possibleSolitaire = (Object.values(selectedVariant.price)[0] || {}).solitaire?.details || [];
        const hasDiamond = Boolean(diamondTotalPrice);
        const hasSolitaire = Boolean(possibleSolitaire.length);

        if (hasDiamond && hasSolitaire) {
          // show both sections â€” solitaire will be populated below
          diamondSectionEl.classList.remove('hide-pb-section');
        } else {
          if (!hasDiamond) diamondSectionEl.classList.add('hide-pb-section');
          else diamondSectionEl.classList.remove('hide-pb-section');
        }
        const sizeKey = Object.keys(selectedVariant.price)[0];
        const priceData = selectedVariant.price[sizeKey];
        console.log('ðŸ’° Price breakdown:', priceData);
        const details = getVariantDetails(selectedVariant);
        // --- Title Section ---
        priceBreakupModal.querySelector('.pb-title-name').textContent = `${selectedVariantName} - Price Breakdown`;
        priceBreakupModal.querySelector('.pb-title-subtitle').textContent = priceBreakDownTopSubTitleText;
        // --- Solitaire Section ---
        // abhi - Need to create diamond like second popup for solitaire
        const solitaireDetails = priceData.solitaire?.details || [];
        if (solitaireDetails.length !== 0) {
          const totalPrice = solitaireDetails.reduce((sum, d) => sum + (d.price || 0), 0);
          const totalCarat = solitaireDetails.reduce((sum, d) => sum + (d.carat || 0), 0);
          priceBreakupModal.querySelector('.solitaire-price').textContent = `â‚¹ ${formatPrice(totalPrice)}/-`;
          // Display whether solitaire is Natural or Lab Grown based on data
          const solTypeRaw = priceData.solitaire?.type || '';
          const solOrigin = /lab/i.test(solTypeRaw) ? 'Lab Grown' : 'Natural';
          priceBreakupModal.querySelector('.solitaire-shape').textContent = solOrigin;
          priceBreakupModal.querySelector('.solitaire-details').textContent = `${formatCarat(totalCarat)} ct `;

          const solSectionEl = priceBreakupModal.querySelector('.solitaire-section');
          // store structured solitaire data for modal use
          solSectionEl.dataset.sPrice = String(totalPrice || 0);
          solSectionEl.dataset.sPriceFormatted = `â‚¹${formatPrice(totalPrice)}`;
          solSectionEl.dataset.sCarat = String(totalCarat || 0);
          solSectionEl.dataset.sColor = String(solitaireDetails[0].color || 'â€”');
          solSectionEl.dataset.sClarity = String(solitaireDetails[0].clarity || 'â€”');
          solSectionEl.dataset.sShape = String(solitaireDetails[0].shape || '');
          solSectionEl.dataset.sGrade = `${solitaireDetails[0].color || 'â€”'}-${solitaireDetails[0].clarity || 'â€”'}`;
          // store the origin (Natural / Lab Grown) for the solitaire
          solSectionEl.dataset.sOrigin = solOrigin;
          // store full details array so modal can render multiple solitaire cards when present
          try {
            solSectionEl.dataset.sDetails = JSON.stringify(solitaireDetails || []);
          } catch (e) {
            solSectionEl.dataset.sDetails = '[]';
          }

          solSectionEl.classList.remove('hidden');
        }
        // --- Diamond Section ---
        priceBreakupModal.querySelector('.diamond-price').textContent = `â‚¹ ${formatPrice(diamondTotalPrice)}/-`;
        // Display whether diamond is Natural or Lab Grown based on data
        const diamondTypeRaw = priceData.diamond?.type || '';
        const diamondOrigin = /lab/i.test(diamondTypeRaw) ? 'Lab Grown' : 'Natural';
        priceBreakupModal.querySelector('.diamond-type').textContent = diamondOrigin;
        priceBreakupModal.querySelector(
          '.diamond-details'
        ).textContent = `${formatCarat(diamondTotalCarat)} ct `;
        // --- Metal Section ---
        priceBreakupModal.querySelector('.metal-price').textContent = `â‚¹ ${formatPrice(priceData.metal_price)}/-`;
        priceBreakupModal.querySelector('.metal-type').textContent = details.metalType;
        priceBreakupModal.querySelector(
          '.metal-details'
        ).textContent = `${details.metalPurity} | ${details.metalWeight} gm`;
        // --- Making Charges ---
        priceBreakupModal.querySelector('.making-price').textContent = `â‚¹ ${formatPrice(priceData.making_charges)}/-`;
        // --- GST ---
        priceBreakupModal.querySelector('.gst-price').textContent = `â‚¹ ${formatPrice(priceData.gst)}/-`;
        // --- Total Price ---
        priceBreakupModal.querySelector('.total-price').textContent = `â‚¹ ${formatPrice(priceData.total_price_with_gst)}/-`;
        // Show modal
        priceBreakupModal?.classList.remove('hidden');
        pbOverlay?.classList.remove('hidden');
        if (!diamondModal) return;
        diamondModal.querySelector(
          '.diamond-modal-metal'
        ).textContent = `${selectedVariant.variantName} - ${details.metalPurity}`;

        const diamondsData = priceData.diamond || {};
        // --- Round Diamond Card ---
        const roundDiamonds = diamondsData.round || [];
        const roundDiamondsPrice = roundDiamonds.reduce((sum, d) => sum + (d.price || 0), 0);
        if (roundDiamonds.length) {
          const totalCarat = roundDiamonds.reduce((sum, d) => sum + (d.carat || 0), 0);
          diamondModal.querySelector('.round-diamond-card').classList.remove('hidden');
          diamondModal.querySelector('.round-diamond-price').textContent = `â‚¹ ${formatPrice(roundDiamondsPrice)}/-`;
          diamondModal.querySelector('.round-diamond-carat').textContent = `Carat: ${formatCarat(totalCarat)} ct`;
          diamondModal.querySelector('.round-diamond-grade').textContent = `Grade: ${priceData.diamond.color || 'â€”'}-${
            priceData.diamond.clarity || 'â€”'
          }`;
        }

        // --- Other Diamond Card ---
        const otherDiamonds = diamondsData.others || [];
        const otherDiamondsPrice = otherDiamonds.reduce((sum, d) => sum + (d.price || 0), 0);
        if (otherDiamonds.length) {
          const totalCaratOther = otherDiamonds.reduce((sum, d) => sum + (d.carat || 0), 0);
          diamondModal.querySelector('.other-diamond-card').classList.remove('hidden');
          diamondModal.querySelector('.other-diamond-price').textContent = `â‚¹ ${formatPrice(otherDiamondsPrice)}/-`;
          diamondModal.querySelector('.other-diamond-carat').textContent = `Carat: ${formatCarat(totalCaratOther)} ct`;
          diamondModal.querySelector('.other-diamond-grade').textContent = `Grade: ${priceData.diamond.color || 'â€”'}-${
            priceData.diamond.clarity || 'â€”'
          }`;
        }
        // --- Totals ---
        const totalDiamondsCount = [...roundDiamonds, ...otherDiamonds].reduce(
          (sum, d) => sum + (d.total_count || 0),
          0
        );
        diamondModal.querySelector('.total-pieces').textContent = `${totalDiamondsCount} pieces`;
        diamondModal.querySelector('.total-value').textContent = `â‚¹ ${formatPrice(otherDiamondsPrice + roundDiamondsPrice)}/-`;
      });
    });
    // ðŸ§  Helper: Extract diamond & metal details
    function getVariantDetails(selectedVariant) {
      const sizeKey = Object.keys(selectedVariant.price)[0];
      const data = selectedVariant.price[sizeKey];
      const diamond = data?.diamond || {};
      const solitaire = data?.solitaire || {};
      const diamondType = diamond.type || solitaire.details?.[0]?.type || 'â€”';
      const diamondCarat =
        diamond.round?.reduce((sum, d) => sum + (d.carat || 0), 0) ||
        solitaire.details?.reduce((sum, d) => sum + (d.carat || 0), 0) ||
        0;
      const diamondColor = diamond.color || solitaire.details?.[0]?.color || 'â€”';
      const diamondClarity = diamond.clarity || solitaire.details?.[0]?.clarity || 'â€”';
      const diamondShape = (diamond.round?.length ? 'Round' : solitaire.details?.[0]?.shape) || '';
      const metalType = data.metal?.type || 'â€”';
      const metalPurity = data.metal?.purity || 'â€”';
      const metalWeight = data.metal?.weight || 'â€”';
      return {
        diamondType,
        diamondCarat: diamondCarat.toFixed(3),
        diamondColor,
        diamondClarity,
        diamondShape,
        metalType,
        metalPurity,
        metalWeight,
      };
    }
    // ðŸ’Ž Helper: Sum diamond prices (round + others)
    function sumDiamondPrice(diamond) {
      if (!diamond || !diamond.round) return 0;
      return diamond.round.reduce((sum, d) => sum + (d.price || 0), 0);
    }
    // ðŸ’° Helper: Format price neatly
    function formatPrice(num) {
      return Number(num).toLocaleString('en-IN', { maximumFractionDigits: 2 });
    }
    function formatCarat(num) {
      const n = Number(num) || 0;
      return n.toFixed(3);
    } 
  });
  document.querySelectorAll('.ai-question').forEach((section) => {
    section.addEventListener('click', (e) => {
      if (!e.target.classList.contains('ai-option')) return;
      const option = e.target;
      const isPriority = section.id === 'priority';
      const errorEl = section.querySelector('.ai-error');

      // Helper to hide/show error
      const showError = () => {
        if (errorEl) {
          errorEl.classList.remove('hidden');
          setTimeout(() => errorEl.classList.add('hidden'), 1200);
        }
      };

      if (isPriority) {
        // Use a timestamp to track selection order so we can deterministically remove the oldest selections.
        const selectedEls = Array.from(section.querySelectorAll('.ai-option.selected'));
        const isOptionSelected = option.classList.contains('selected');

        if (isOptionSelected) {
          // Unselecting: allow removing even the last selection (user may deselect everything)
          option.classList.remove('selected');
          delete option.dataset.selectedAt;
        } else {
          // Selecting: mark selection time
          option.classList.add('selected');
          option.dataset.selectedAt = Date.now().toString();

          // If more than 2 selected, remove the oldest selected(s)
          const afterSelected = Array.from(section.querySelectorAll('.ai-option.selected'));
          if (afterSelected.length > 2) {
            afterSelected
              .sort((a, b) => parseInt(a.dataset.selectedAt || '0', 10) - parseInt(b.dataset.selectedAt || '0', 10))
              .slice(0, afterSelected.length - 2)
              .forEach((toRemove) => {
                toRemove.classList.remove('selected');
                delete toRemove.dataset.selectedAt;
              });
          }
        }

        if (errorEl) errorEl.classList.add('hidden');
      } else {
        // Single-select behavior for other questions
        section.querySelectorAll('.ai-option').forEach((opt) => {
          opt.classList.remove('selected');
          delete opt.dataset.selectedAt;
        });
        option.classList.add('selected');
        option.dataset.selectedAt = Date.now().toString();
        if (errorEl) errorEl.classList.add('hidden');
      }
    });
  });
  function openRecommendationStep2() {
    document.querySelector('.variant-help-box.step-1').style.display = 'none';
    document.querySelector('.variant-help-box.step-2').style.display = 'flex';
  }
  async function getRecommendation() {
    const selections = [];
    let allSelected = true;
    document.querySelectorAll('.ai-question').forEach((section) => {
      if (section.id === 'priority') {
        // Allow up to 2 selections for priority; push each selected option as a separate element
        const selectedEls = Array.from(section.querySelectorAll('.ai-option.selected'));
        if (selectedEls.length > 0) {
          selectedEls.forEach((s) => selections.push(s.innerText.trim()));
        } else {
          section.querySelector('.ai-error').classList.remove('hidden');
          allSelected = false;
        }
      } else {
        const selected = section.querySelector('.ai-option.selected');
        if (selected) {
          selections.push(selected.innerText.trim());
        } else {
          section.querySelector('.ai-error').classList.remove('hidden');
          allSelected = false;
        }
      }
    });
    if (allSelected) {
      document.querySelector('.get-recommendation-btn').style.display = 'none';
      document.querySelector('.questionWrapper').style.display = 'none';
      document.querySelector('.ai-loader').classList.remove('hidden');
      const recommendedVariant = await getRecommendedVariant(selections);
      const firstVariant = recommendedVariant?.data[0];

      document.querySelector('.ai-loader').classList.add('hidden');
      document.querySelector('.try-again-btn').classList.remove('hidden');
      if (firstVariant) {
        const selectedVariant = document.querySelector(
          `.variant-link[data-option1="${firstVariant.option1}"][data-option2="${firstVariant.option2}"]`
        );

        const variant_id = selectedVariant.getAttribute('data-variant-id');
        document.querySelector('.choose-variant-btn').setAttribute('data-variant-id', variant_id);

        const variantName = selectedVariant.querySelector('.variant-name').textContent;
        const variantPrice = selectedVariant.querySelector('.variant-price').textContent;
        const answerWrapper = document.querySelector('.answerWrapper');
        answerWrapper.querySelector('.product-name').innerText = variantName;
        answerWrapper.querySelector('.product-price').innerText = variantPrice;
        answerWrapper.querySelector('.product-detail').innerText = `${firstVariant.option1}-${firstVariant.option2}`;
        answerWrapper.querySelector('.note').innerText = `Based on your preferences: ${selections.join(', ')}`;
        answerWrapper.style.display = 'block';
        document.querySelector('.choose-variant-btn').classList.remove('hidden');
      } else {
        document.querySelector('.ai-api-error').classList.remove('hidden');
      }
    } else {
      // If inputs are missing, scroll to the first visible error message and abort.
      const firstError = document.querySelector('.ai-error:not(.hidden)');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }
  }
  function chooseRecommendedVariant(btn) {
    const variant_id = btn.getAttribute('data-variant-id');
    console.log('Write code to choose abhi', variant_id);
    document.querySelector(`.variant-box[data-variant-id="${variant_id}"]`).click();
    tryAgain();
  }
  function tryAgain() {
    document.querySelector('.variant-help-box.step-1').style.display = 'flex';
    document.querySelector('.questionWrapper').style.display = 'block';
    document.querySelector('.answerWrapper').style.display = 'none';
    document.querySelector('.variant-help-box.step-2').style.display = 'none';
    document.querySelectorAll('.ai-option.selected').forEach((x) => x.classList.remove('selected'));
    document.querySelector('.get-recommendation-btn').style.display = 'block';
    document.querySelector('.choose-variant-btn').classList.add('hidden');
    document.querySelector('.try-again-btn').classList.add('hidden');
    document.querySelector('.ai-api-error').classList.add('hidden');
  }
  async function getRecommendedVariant(selectedOptions, customer_id = '998923478236523') {
    // this user id needs to be updated later (abhi)
    const myHeaders = new Headers();
    myHeaders.append('Content-Type', 'application/json');
    const product_tags = "{{ product.tags | join: ', '  }}";
    const raw = JSON.stringify({
      Product_tag: product_tags,
      user_id: customer_id,
      name: 'Test', // this name of customer needs to be updated later (abhi)
      mobile_num: '9876543210', // this mobile_num needs to be updated later (abhi)
      user_answers: selectedOptions, // [
      //  "Investment & Resale, Exclusivity & Emotion over logic",
      //  "Occasionally",
      //   "White-collared",
      //   "Yellow",
      //   "No"
      // ]
    });
    const requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: raw,
      redirect: 'follow',
    };
    try {
      const result = await fetch(`${window.EA_MODULE_BASE_URL}/price/price-recommendation`, requestOptions);
      const data = await result.json();
      return data;
    } catch (err) {
      console.log('AI recommendation API error', err);
    }
  }
</script>
